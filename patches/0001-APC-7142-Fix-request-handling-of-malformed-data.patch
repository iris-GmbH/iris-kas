From 462382392fbbc7ad919e65b6f86969504b72c780 Mon Sep 17 00:00:00 2001
From: Michael Glembotzki <Michael.Glembotzki@iris-sensing.com>
Date: Mon, 18 Sep 2023 09:22:09 +0200
Subject: [PATCH] [APC-7142] Fix request handling of malformed data

Patch submitted and accepted:
https://patchwork.ozlabs.org/project/swupdate/patch/20230915104049.52749-1-Michael.Glembotzki@iris-sensing.com/

Signed-off-by: Michael Glembotzki <Michael.Glembotzki@iris-sensing.com>
---
 recipes-support/swupdate/swupdate.inc         |  1 +
 ...uest-handling-of-malformed-data-for-.patch | 36 +++++++++++++++++++
 2 files changed, 37 insertions(+)
 create mode 100644 recipes-support/swupdate/swupdate/0001-mongoose-Fix-request-handling-of-malformed-data-for-.patch

diff --git a/recipes-support/swupdate/swupdate.inc b/recipes-support/swupdate/swupdate.inc
index faaf03d..c398402 100644
--- a/recipes-support/swupdate/swupdate.inc
+++ b/recipes-support/swupdate/swupdate.inc
@@ -29,6 +29,7 @@ SRC_URI = "git://github.com/sbabic/swupdate.git;protocol=https;branch=master \
     file://tmpfiles-swupdate.conf \
     file://10-mongoose-args \
     file://90-start-progress \
+    file://0001-mongoose-Fix-request-handling-of-malformed-data-for-.patch \
 "
 
 LTOEXTRA += "-flto-partition=none"
diff --git a/recipes-support/swupdate/swupdate/0001-mongoose-Fix-request-handling-of-malformed-data-for-.patch b/recipes-support/swupdate/swupdate/0001-mongoose-Fix-request-handling-of-malformed-data-for-.patch
new file mode 100644
index 0000000..60cae6b
--- /dev/null
+++ b/recipes-support/swupdate/swupdate/0001-mongoose-Fix-request-handling-of-malformed-data-for-.patch
@@ -0,0 +1,36 @@
+From d2730a09943016dcc1d2c12164378ea1155854c2 Mon Sep 17 00:00:00 2001
+From: Michael Glembotzki <Michael.Glembotzki@iris-sensing.com>
+Date: Fri, 15 Sep 2023 10:44:43 +0200
+Subject: [PATCH] mongoose: Fix request handling of malformed data for
+ multipart/formdata
+
+Check whether the connection pfn_data is set
+
+How to reproduce the bug?
+$ curl "http://localhost:8080/swupdate/upload" -X POST \
+    -H "Content-Type: multipart/form-data" -d {}
+
+Signed-off-by: Michael Glembotzki <Michael.Glembotzki@iris-sensing.com>
+---
+ mongoose/mongoose_multipart.c | 5 +++++
+ 1 file changed, 5 insertions(+)
+
+diff --git a/mongoose/mongoose_multipart.c b/mongoose/mongoose_multipart.c
+index b1741c9..fccc5a6 100644
+--- a/mongoose/mongoose_multipart.c
++++ b/mongoose/mongoose_multipart.c
+@@ -270,6 +270,11 @@ static int mg_http_multipart_continue_wait_for_chunk(struct mg_connection *c) {
+ 
+ static void mg_http_multipart_continue(struct mg_connection *c) {
+ 	struct mg_http_multipart_stream *mp_stream = c->pfn_data;
++
++	if(mp_stream == NULL) {
++		return;
++	}
++
+ 	while (1) {
+ 		switch (mp_stream->state) {
+ 			case MPS_BEGIN: {
+-- 
+2.42.0
+
-- 
2.42.0

